{% extends "base.html" %}

{% block title %}Nyhetssammanfattning{% endblock %}
{% block header %}Nyhetssammanfattning{% endblock %}

{% block subheader %}
  {% if summary %}
    Senast uppdaterad: {{ summary_time }} · Artiklar: {{ n_articles }}
  {% else %}
    Ingen sammanfattning sparad ännu.
  {% endif %}
{% endblock %}

{% block top_actions %}
  <button class="btn btn-primary" type="button" id="openRefresh">Refresh</button>
{% endblock %}

{% block content %}

  <div class="card">
    <div class="status">
      <strong>Status:</strong>
      <span id="jobPill" class="pill">idle</span>
      <span class="muted" id="jobMsg"></span>
    </div>
    <div class="muted" id="jobTimes" style="margin-top:6px;"></div>
  </div>

  <div class="layout">
    <div class="card sidebar">
      <h3 style="margin-bottom: 10px;">Sammanfattningar</h3>
      {% if summary_list %}
        <ul class="summary-list">
          {% for it in summary_list %}
            <li class="summary-item {% if selected_id and it.id == selected_id %}active{% endif %}">
              <a href="{{ url_for('index') }}?summary_id={{ it.id }}">
                <div class="summary-item-title">{{ it.time }}</div>
                <div class="muted">Artiklar: {{ it.n_articles }}</div>
              </a>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">Inga sammanfattningar ännu.</div>
      {% endif %}
    </div>

    <div>
      {% if summary %}
        <div class="card">
          {{ summary_html|safe }}
        </div>
      {% else %}
        <div class="card">
          <p>Tryck <strong>Refresh</strong> för att hämta och summera.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Refresh Modal -->
  <div class="modal-backdrop" id="refreshBackdrop" aria-hidden="true"></div>
  <div class="modal" id="refreshModal" role="dialog" aria-modal="true" aria-labelledby="refreshTitle" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="refreshTitle">Refresh – inställningar</h3>
        <button class="btn" type="button" id="closeRefresh">Stäng</button>
      </div>

      <form method="POST" action="{{ url_for('refresh') }}">
        <div class="form-row">
          <label class="form-label">Tidsperspektiv</label>
          <div class="form-inline">
            <input class="input" name="lookback_value" type="number" min="1" value="{{ default_lb_value }}" style="width:120px;" />
            <select class="select" name="lookback_unit">
              <option value="h" {% if default_lb_unit == "h" %}selected{% endif %}>h</option>
              <option value="d" {% if default_lb_unit == "d" %}selected{% endif %}>d</option>
              <option value="w" {% if default_lb_unit == "w" %}selected{% endif %}>w</option>
              <option value="m" {% if default_lb_unit == "m" %}selected{% endif %}>m</option>
              <option value="y" {% if default_lb_unit == "y" %}selected{% endif %}>y</option>
            </select>
            <span class="muted">Ex: 24h, 3d</span>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">Prompt-paket</label>
          <div class="form-inline">
            <select class="select" name="prompt_package">
              {% for pkg in prompt_packages %}
                <option value="{{ pkg }}" {% if default_prompt_package == pkg %}selected{% endif %}>
                  {{ pkg }}
                </option>
              {% endfor %}
            </select>
            <span class="muted">Väljs per körning (config.yaml är default).</span>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">Källor</label>
          <div class="source-grid">
            {% for s in source_options %}
              <label class="chk">
                <input type="checkbox" name="sources" value="{{ s.name }}" {% if s.default_checked %}checked{% endif %} />
                <span>
                  <strong>{{ s.name }}</strong>
                  {% if s.url %}<span class="muted">· {{ s.url }}</span>{% endif %}
                </span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" id="cancelRefresh">Avbryt</button>
          <button class="btn btn-primary" type="submit">Kör refresh</button>
        </div>
      </form>
    </div>
  </div>

<script>
(function() {
  // --- modal open/close ---
  const openBtn = document.getElementById("openRefresh");
  const modal = document.getElementById("refreshModal");
  const backdrop = document.getElementById("refreshBackdrop");
  const closeBtn = document.getElementById("closeRefresh");
  const cancelBtn = document.getElementById("cancelRefresh");

  function openModal() {
    modal.setAttribute("aria-hidden","false");
    backdrop.setAttribute("aria-hidden","false");
    modal.classList.add("open");
    backdrop.classList.add("open");
  }
  function closeModal() {
    modal.setAttribute("aria-hidden","true");
    backdrop.setAttribute("aria-hidden","true");
    modal.classList.remove("open");
    backdrop.classList.remove("open");
  }

  openBtn?.addEventListener("click", openModal);
  closeBtn?.addEventListener("click", closeModal);
  cancelBtn?.addEventListener("click", closeModal);
  backdrop?.addEventListener("click", closeModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });

  // --- SSE status (same as before) ---
  const params = new URLSearchParams(window.location.search);
  const jobId = params.get("job");
  const pill = document.getElementById("jobPill");
  const msg = document.getElementById("jobMsg");
  const times = document.getElementById("jobTimes");

  function setPill(status) {
    pill.classList.remove("ok","err");
    pill.textContent = status || "idle";
    if (status === "done") pill.classList.add("ok");
    if (status === "error") pill.classList.add("err");
  }

  function fmt(ts) {
    if (!ts) return "";
    const d = new Date(ts * 1000);
    return d.toISOString().replace("T", " ").slice(0, 19);
  }

  if (!jobId) {
    setPill("idle");
    return;
  }

  setPill("running");

  const es = new EventSource(`/api/status/stream/${jobId}`);

  es.onmessage = (ev) => {
    const data = JSON.parse(ev.data);

    setPill(data.status);
    msg.textContent = data.message || "";

    const created = fmt(data.created_at);
    const started = fmt(data.started_at);
    const finished = fmt(data.finished_at);

    let tline = "";
    if (created) tline += `Skapad: ${created}`;
    if (started) tline += (tline ? " · " : "") + `Startad: ${started}`;
    if (finished) tline += (tline ? " · " : "") + `Klar: ${finished}`;
    times.textContent = tline;

    if (data.status === "done") {
      es.close();
      const url = new URL(window.location.href);
      url.searchParams.delete("job");
      window.location.replace(url.toString());
    }
    if (data.status === "error") {
      es.close();
    }
  };

  es.onerror = () => {
    setPill("error");
    msg.textContent = "Status-anslutning bröts.";
    es.close();
  };
})();
</script>

{% endblock %}
