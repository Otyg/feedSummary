{% extends "base.html" %}

{% block title %}Nyhetssammanfattning{% endblock %}
{% block header %}Nyhetssammanfattning{% endblock %}

{% block subheader %}
  {% if summary %}
    Senast uppdaterad: {{ summary_time }} · Artiklar: {{ n_articles }}
  {% else %}
    Ingen sammanfattning sparad ännu.
  {% endif %}
{% endblock %}

{% block top_actions %}
  <form method="POST" action="{{ url_for('refresh') }}" style="margin:0;">
    <button class="btn btn-primary" type="submit">Refresh</button>
  </form>
{% endblock %}

{% block content %}

  <div class="card">
    <div class="status">
      <strong>Status:</strong>
      <span id="jobPill" class="pill">idle</span>
      <span class="muted" id="jobMsg"></span>
    </div>
    <div class="muted" id="jobTimes" style="margin-top:6px;"></div>
  </div>

  <div class="layout">
    <!-- Sidebar -->
    <div class="card sidebar">
      <h3 style="margin-bottom: 10px;">Sammanfattningar</h3>

      {% if summary_list %}
        <ul class="summary-list">
          {% for it in summary_list %}
            <li class="summary-item {% if selected_id and it.id == selected_id %}active{% endif %}">
              <a href="{{ url_for('index') }}?summary_id={{ it.id }}">
                <div class="summary-item-title">{{ it.time }}</div>
                <div class="muted">Artiklar: {{ it.n_articles }}</div>
              </a>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">Inga sammanfattningar ännu.</div>
      {% endif %}
    </div>

    <!-- Main content -->
    <div>
      {% if summary %}
        <div class="grid-main">
          <div class="card">
            {{ summary_html|safe }}
          </div>
        </div>
      {% else %}
        <div class="card">
          <p>Tryck <strong>Refresh</strong> för att hämta och summera.</p>
        </div>
      {% endif %}
    </div>
  </div>

<script>
(function() {
  const params = new URLSearchParams(window.location.search);
  const jobId = params.get("job");
  const pill = document.getElementById("jobPill");
  const msg = document.getElementById("jobMsg");
  const times = document.getElementById("jobTimes");

  function setPill(status) {
    pill.classList.remove("ok","err");
    pill.textContent = status || "idle";
    if (status === "done") pill.classList.add("ok");
    if (status === "error") pill.classList.add("err");
  }

  function fmt(ts) {
    if (!ts) return "";
    const d = new Date(ts * 1000);
    return d.toISOString().replace("T", " ").slice(0, 19);
  }

  if (!jobId) {
    setPill("idle");
    return;
  }

  setPill("running");

  const es = new EventSource(`/api/status/stream/${jobId}`);

  es.onmessage = (ev) => {
    const data = JSON.parse(ev.data);

    setPill(data.status);
    msg.textContent = data.message || "";

    const created = fmt(data.created_at);
    const started = fmt(data.started_at);
    const finished = fmt(data.finished_at);

    let tline = "";
    if (created) tline += `Skapad: ${created}`;
    if (started) tline += (tline ? " · " : "") + `Startad: ${started}`;
    if (finished) tline += (tline ? " · " : "") + `Klar: ${finished}`;
    times.textContent = tline;

    if (data.status === "done") {
      es.close();
      // Behåll ev. summary_id men ta bort job
      const url = new URL(window.location.href);
      url.searchParams.delete("job");
      window.location.replace(url.toString());
    }
    if (data.status === "error") {
      es.close();
    }
  };

  es.onerror = () => {
    setPill("error");
    msg.textContent = "Status-anslutning bröts.";
    es.close();
  };
})();
</script>

{% endblock %}
