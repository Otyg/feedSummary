{% extends "base.html" %}

{% block title %}Artiklar{% endblock %}
{% block header %}Artiklar{% endblock %}

{% block subheader %}
  Visar {{ filtered_count }} av {{ total_count }} artiklar
{% endblock %}

{% block top_actions %}
  <a class="btn" href="{{ url_for('index') }}">Tillbaka</a>
{% endblock %}

{% block content %}

{# auto-open filter panel if any filter is active #}
{% set has_filters =
  (selected_sources and (selected_sources|length > 0)) or
  (selected_topics and (selected_topics|length > 0)) or
  (from_date and from_date|length > 0) or
  (to_date and to_date|length > 0)
%}

{# allow both source_options (preferred) and sources (fallback) #}
{% set _source_options = source_options if source_options is defined and source_options else [] %}
{% set _topic_options = topic_options if topic_options is defined and topic_options else [] %}

<div class="card">
  <div class="status" style="justify-content: space-between;">
    <div>
      <strong>Filter</strong>
      {% if has_filters %}
        <span class="muted">
          · Aktiva:
          {% if from_date %} från {{ from_date }}{% endif %}
          {% if to_date %} till {{ to_date }}{% endif %}
          {% if selected_topics and selected_topics|length > 0 %}
            · ämnen: {{ selected_topics|length }}
          {% endif %}
          {% if selected_sources and selected_sources|length > 0 %}
            · källor: {{ selected_sources|length }}
          {% endif %}
        </span>
      {% else %}
        <span class="muted">· Inga aktiva filter</span>
      {% endif %}
    </div>

    <button class="btn" type="button" id="toggleFilters" aria-expanded="{{ 'true' if has_filters else 'false' }}">
      {{ 'Dölj filter' if has_filters else 'Visa filter' }}
    </button>
  </div>

  <div id="filtersPanel" style="margin-top: 12px; {% if not has_filters %}display:none;{% endif %}">
    <form method="GET" action="{{ url_for('list_articles') }}">
      <div class="form-row">
        <label class="form-label">Datumintervall</label>
        <div class="form-inline">
          <input class="input" type="date" name="from" value="{{ from_date }}" />
          <span class="muted">→</span>
          <input class="input" type="date" name="to" value="{{ to_date }}" />
          <span class="muted">YYYY-MM-DD</span>
        </div>
      </div>

      {% if _topic_options and (_topic_options|length > 0) %}
      <div class="form-row">
        <label class="form-label">Ämnen</label>

        <div class="form-inline" style="margin: 6px 0 10px 0;">
          <button class="btn" type="button" id="selectAllTopics">Markera alla ämnen</button>
          <button class="btn" type="button" id="deselectAllTopics">Avmarkera alla ämnen</button>
          <span class="muted">Markerade ämnen markerar matchande källor.</span>
        </div>

        <div class="source-grid" id="topicGrid">
          {% for t in _topic_options %}
            <label class="chk">
              <input
                type="checkbox"
                name="topics"
                value="{{ t }}"
                {% if selected_topics and (t in selected_topics) %}checked{% endif %}
              />
              <span><strong>{{ t }}</strong></span>
            </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="form-row">
        <label class="form-label">Källor</label>

        <div class="form-inline" style="margin: 6px 0 10px 0;">
          <button class="btn" type="button" id="selectAllSources">Markera alla</button>
          <button class="btn" type="button" id="deselectAllSources">Avmarkera alla</button>
          <button class="btn btn-primary" type="submit">Filtrera</button>
          <a class="btn" href="{{ url_for('list_articles') }}">Rensa</a>
        </div>

        <div class="source-grid" id="sourceGrid">
          {% if _source_options and (_source_options|length > 0) %}
            {% for s in _source_options %}
              <label class="chk">
                <input
                  type="checkbox"
                  name="sources"
                  value="{{ s.name }}"
                  data-topics="{{ (s.topics or [])|join(',') }}"
                  {% if selected_sources and (s.name in selected_sources) %}checked{% endif %}
                />
                <span>
                  <strong>{{ s.name }}</strong>
                  {% if s.topics and s.topics|length > 0 %}
                    <span class="muted">· {{ s.topics|join(', ') }}</span>
                  {% endif %}
                </span>
              </label>
            {% endfor %}
          {% else %}
            {# fallback: only a list of source strings exists #}
            {% for s in sources %}
              <label class="chk">
                <input
                  type="checkbox"
                  name="sources"
                  value="{{ s }}"
                  data-topics=""
                  {% if selected_sources and (s in selected_sources) %}checked{% endif %}
                />
                <span><strong>{{ s }}</strong></span>
              </label>
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </form>
  </div>
</div>

<div>
  {% for a in articles %}
    <div class="card">
      <div>
        <strong>
          <a href="{{ a.url }}" target="_blank" rel="noopener">{{ a.title }}</a>
        </strong>
      </div>
      <div class="muted">
        {{ a.source }}
        {% if a.published %} · {{ a.published }}{% endif %}
      </div>
      <p>{{ a.text }}</p>
    </div>
  {% endfor %}
</div>

<script>
(function() {
  // Toggle filters panel
  const btn = document.getElementById("toggleFilters");
  const panel = document.getElementById("filtersPanel");

  function setOpen(open) {
    if (!panel || !btn) return;
    panel.style.display = open ? "block" : "none";
    btn.setAttribute("aria-expanded", open ? "true" : "false");
    btn.textContent = open ? "Dölj filter" : "Visa filter";
  }

  btn?.addEventListener("click", () => {
    const isOpen = panel && panel.style.display !== "none";
    setOpen(!isOpen);
  });

  // Select/deselect all sources
  const sourceGrid = document.getElementById("sourceGrid");
  const btnAll = document.getElementById("selectAllSources");
  const btnNone = document.getElementById("deselectAllSources");

  function getSourceBoxes() {
    if (!sourceGrid) return [];
    return Array.from(sourceGrid.querySelectorAll('input[type="checkbox"][name="sources"]'));
  }

  function setAllSources(checked) {
    const boxes = getSourceBoxes();
    boxes.forEach((b) => { b.checked = !!checked; });
  }

  btnAll?.addEventListener("click", () => setAllSources(true));
  btnNone?.addEventListener("click", () => setAllSources(false));

  // Topics -> sources mapping
  const topicGrid = document.getElementById("topicGrid");
  const btnTopicsAll = document.getElementById("selectAllTopics");
  const btnTopicsNone = document.getElementById("deselectAllTopics");

  function sourceHasTopic(box, topic) {
    const raw = (box.getAttribute("data-topics") || "").trim();
    if (!raw) return false;
    const parts = raw.split(",").map(s => s.trim()).filter(Boolean);
    return parts.includes(topic);
  }

  function applyTopicToSources(topic, checked) {
    const boxes = getSourceBoxes();
    boxes.forEach((b) => {
      if (sourceHasTopic(b, topic)) {
        b.checked = !!checked;
      }
    });
  }

  function setAllTopics(checked) {
    if (!topicGrid) return;
    const boxes = topicGrid.querySelectorAll('input[type="checkbox"][name="topics"]');
    boxes.forEach((b) => { b.checked = !!checked; });
    boxes.forEach((b) => { applyTopicToSources(b.value, checked); });
  }

  topicGrid?.addEventListener("change", (e) => {
    const tbox = e.target;
    if (!tbox || tbox.name !== "topics") return;
    applyTopicToSources(tbox.value, tbox.checked);
  });

  btnTopicsAll?.addEventListener("click", () => setAllTopics(true));
  btnTopicsNone?.addEventListener("click", () => setAllTopics(false));
})();
</script>

{% endblock %}